# Cloud Migration Summary - SSH Key Authentication

Complete setup for dual-environment (local + cloud) with SSH key authentication and sync capabilities.

## ğŸ“¦ What Was Created

### 1. Documentation
- âœ… **DUAL_ENVIRONMENT_SETUP.md** - Complete guide for maintaining both environments
- âœ… **PRE_MIGRATION_CHECKLIST.md** - Preparation checklist before migration
- âœ… **MIGRATION_GUIDE.md** - Detailed step-by-step migration instructions
- âœ… **CLOUD_SERVER_QUICKSTART.md** - Daily operations reference
- âœ… **CLOUD_MIGRATION_SUMMARY.md** - This file

### 2. Deployment Scripts
- âœ… **scripts/deploy_to_cloud.sh** - Automated deployment with SSH key support
- âœ… **scripts/setup_dual_environment.sh** - Interactive setup wizard

### 3. Sync Scripts
- âœ… **scripts/sync_to_cloud.sh** - Push local changes to cloud
- âœ… **scripts/sync_from_cloud.sh** - Pull cloud changes to local
- âœ… **scripts/sync_models.sh** - Sync models (direct or via S3)
- âœ… **scripts/check_both_environments.sh** - Status check for both environments

## ğŸš€ Quick Start (3 Steps)

### Step 1: Run Setup Wizard (5 minutes)
```bash
cd /home/numan/crpbot
./scripts/setup_dual_environment.sh
```

This will:
- Ask for your cloud server IP and username
- Configure SSH key (or generate new one)
- Test SSH connection
- Create SSH config alias for easy access
- Save configuration for sync scripts

### Step 2: Deploy to Cloud (30-60 minutes)
```bash
# After setup wizard completes:
./scripts/deploy_to_cloud.sh

# Or if you skipped the wizard:
./scripts/deploy_to_cloud.sh -k ~/.ssh/your_key user@server-ip
```

The script will:
- âœ… Verify SSH connection (with your key)
- âœ… Install all dependencies on cloud server
- âœ… Clone your git repository
- âœ… Transfer configuration files (.env, .db_password, etc.)
- âœ… Optionally download data/models from S3
- âœ… Run tests to verify deployment

### Step 3: Verify Both Environments (5 minutes)
```bash
# Check status of both environments
./scripts/check_both_environments.sh

# Should show:
# - Both environments have same git commit
# - Python version and dependencies installed
# - Data and models present
# - Sync status
```

## ğŸ’» SSH Key Authentication

### Your Server Setup Requirements
âœ… **No password authentication** - Only SSH keys allowed
âœ… **Public key must be in server's ~/.ssh/authorized_keys**
âœ… **Key must have correct permissions** (600 for private, 644 for public)

### Common SSH Key Locations
```bash
~/.ssh/id_ed25519      # Modern, recommended
~/.ssh/id_rsa          # Traditional RSA key
~/.ssh/crpbot_key      # Custom key (generated by setup wizard)
```

### If You Don't Have a Key Yet
The setup wizard will generate one for you:
```bash
./scripts/setup_dual_environment.sh
# Choose option 3: "No, I need to generate one"
```

Then copy to your server:
```bash
ssh-copy-id -i ~/.ssh/crpbot_key.pub user@your-server-ip
```

## ğŸ”„ Daily Workflow

### Scenario 1: Develop Locally, Deploy to Cloud
```bash
# 1. Make changes locally
cd /home/numan/crpbot
# ... edit files ...

# 2. Test locally
source .venv/bin/activate
make test

# 3. Sync to cloud
./scripts/sync_to_cloud.sh

# Changes are now on cloud server!
```

### Scenario 2: Train on Cloud, Download Results
```bash
# 1. Start training on cloud
ssh crpbot-cloud  # (or whatever alias you created)
cd ~/crpbot
source .venv/bin/activate
make train COIN=BTC EPOCHS=20

# 2. After training, sync models back
# On local machine:
./scripts/sync_models.sh cloud-to-local

# Or via S3 (recommended):
# On cloud: ./scripts/sync_models.sh to-s3
# On local: ./scripts/sync_models.sh from-s3
```

### Scenario 3: Check Both Environments
```bash
# Quick status check
./scripts/check_both_environments.sh

# Shows:
# - Git commits on both
# - Sync status
# - Running processes
# - Resource usage
```

## ğŸ”‘ SSH Configuration

### Option A: SSH Config Alias (Recommended)
Created by setup wizard in `~/.ssh/config`:
```
Host crpbot-cloud
    HostName your-server-ip
    User ubuntu
    IdentityFile ~/.ssh/your_key
    Port 22
    ServerAliveInterval 60
```

Then use simple commands:
```bash
ssh crpbot-cloud
./scripts/deploy_to_cloud.sh crpbot-cloud
./scripts/sync_to_cloud.sh crpbot-cloud
```

### Option B: Full Connection String
Without SSH config:
```bash
ssh -i ~/.ssh/your_key user@server-ip
./scripts/deploy_to_cloud.sh -k ~/.ssh/your_key user@server-ip
./scripts/sync_to_cloud.sh -k ~/.ssh/your_key user@server-ip
```

## ğŸ“Š Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Your Workflow                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      LOCAL MACHINE (Development)     â”‚
        â”‚  /home/numan/crpbot                  â”‚
        â”‚                                      â”‚
        â”‚  â€¢ Quick edits & tests               â”‚
        â”‚  â€¢ Claude Code                       â”‚
        â”‚  â€¢ Git commits                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ git push/pull
                       â”‚ sync scripts
                       â”‚ SSH with key
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      GITHUB/GITLAB (Git Remote)      â”‚
        â”‚  Source of Truth                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ git push/pull
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   CLOUD SERVER (Production/Training) â”‚
        â”‚   ~/crpbot                           â”‚
        â”‚                                      â”‚
        â”‚   â€¢ Long training runs               â”‚
        â”‚   â€¢ Production runtime               â”‚
        â”‚   â€¢ Claude Code (via Remote-SSH)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          AWS S3 (Storage)            â”‚
        â”‚  â€¢ Large data files (764MB)          â”‚
        â”‚  â€¢ Models (3.2MB)                    â”‚
        â”‚  â€¢ Backups                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ All Available Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `setup_dual_environment.sh` | Interactive setup wizard | `./scripts/setup_dual_environment.sh` |
| `deploy_to_cloud.sh` | Full deployment to cloud | `./scripts/deploy_to_cloud.sh [-k KEY] SERVER` |
| `sync_to_cloud.sh` | Push local â†’ cloud | `./scripts/sync_to_cloud.sh` |
| `sync_from_cloud.sh` | Pull cloud â†’ local | `./scripts/sync_from_cloud.sh` |
| `sync_models.sh` | Sync models | `./scripts/sync_models.sh [direction]` |
| `check_both_environments.sh` | Status check | `./scripts/check_both_environments.sh` |

## ğŸ“ Configuration Files

These files are created/used (added to .gitignore):
- `.cloud_server` - Saved server address
- `.ssh_key` - Saved SSH key path
- `.env` - Environment variables (already in .gitignore)
- `.db_password` - Database password (already in .gitignore)

## ğŸ” Security Features

âœ… **SSH Key Authentication**
- No passwords exposed
- Keys have correct permissions (600/644)
- Optional passphrase protection

âœ… **Sensitive Files Protected**
- .env, .db_password never committed to git
- Transferred with secure permissions (600)
- Configuration files in .gitignore

âœ… **Connection Security**
- ServerAliveInterval keeps connections stable
- StrictHostKeyChecking prevents MITM attacks
- Key-based auth only (no password fallback)

## ğŸ› Troubleshooting

### Issue: "Permission denied (publickey)"
```bash
# Check key permissions
chmod 600 ~/.ssh/your_key
chmod 644 ~/.ssh/your_key.pub

# Verify key is on server
ssh-copy-id -i ~/.ssh/your_key.pub user@server

# Test connection
ssh -i ~/.ssh/your_key -v user@server
```

### Issue: "Could not resolve hostname"
```bash
# Verify server IP/hostname
ping your-server-ip

# Update saved server
echo "user@correct-server-ip" > .cloud_server
```

### Issue: "Environments out of sync"
```bash
# Check status
./scripts/check_both_environments.sh

# Sync code
./scripts/sync_to_cloud.sh      # Local â†’ Cloud
./scripts/sync_from_cloud.sh    # Cloud â†’ Local

# Sync models via S3
./scripts/sync_models.sh to-s3
./scripts/sync_models.sh from-s3
```

### Issue: "Git conflicts"
```bash
# On machine with conflicts:
git status
git pull origin main

# Resolve conflicts in editor
# Then:
git add .
git commit -m "Resolve conflicts"
git push origin main
```

## ğŸ“š Recommended Reading Order

For first-time setup:
1. **CLOUD_MIGRATION_SUMMARY.md** (this file) â† You are here
2. **PRE_MIGRATION_CHECKLIST.md** - Complete before deploying
3. **DUAL_ENVIRONMENT_SETUP.md** - Understanding the workflow
4. Run `./scripts/setup_dual_environment.sh`
5. Run `./scripts/deploy_to_cloud.sh`
6. **CLOUD_SERVER_QUICKSTART.md** - Daily operations

## âœ… Pre-Flight Checklist

Before deploying:
- [ ] Have cloud server IP/hostname
- [ ] Have SSH username (e.g., ubuntu)
- [ ] Have SSH key (or ready to generate)
- [ ] SSH key is added to server's authorized_keys
- [ ] Can connect: `ssh -i KEY user@server`
- [ ] Local environment works: `make test`
- [ ] Latest code committed: `git status`
- [ ] AWS credentials configured (for S3 download)

## ğŸ¯ Success Criteria

After deployment, you should have:
- âœ… Both environments with identical git commits
- âœ… Both can run tests: `make test`
- âœ… SSH config alias for easy connection
- âœ… Sync scripts work in both directions
- âœ… Can check status with one command
- âœ… Can work with Claude Code on both machines

## ğŸš€ Ready to Start?

### Immediate Next Steps:
```bash
# 1. Run interactive setup (5 min)
./scripts/setup_dual_environment.sh

# 2. Deploy to cloud (30-60 min)
./scripts/deploy_to_cloud.sh

# 3. Verify deployment
./scripts/check_both_environments.sh

# 4. Start using both environments!
```

### Working with Terminus SSH App:
```bash
# In Terminus, create new host profile with:
# - Host: your-server-ip
# - Username: your-username
# - Auth: SSH Key (point to ~/.ssh/your_key)

# Then connect and work:
ssh crpbot-cloud
cd ~/crpbot
source .venv/bin/activate
make run-dry
```

## ğŸ“ Need Help?

- **SSH Issues**: See DUAL_ENVIRONMENT_SETUP.md â†’ Troubleshooting
- **Deployment Issues**: See MIGRATION_GUIDE.md â†’ Troubleshooting
- **Sync Issues**: Check git status on both machines
- **General Questions**: Review documentation in order listed above

## ğŸ‰ You're All Set!

All scripts support SSH key authentication and are ready to use. The setup wizard makes everything easy!
