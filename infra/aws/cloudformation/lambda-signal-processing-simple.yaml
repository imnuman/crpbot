AWSTemplateFormatVersion: '2010-09-09'
Description: 'CRPBot Lambda Signal Processing Function (Simple Version)'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]

Resources:
  # IAM Role for Lambda
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'crpbot-lambda-signal-role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CRPBotSignalProcessorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:crpbot/coinbase-api/${Environment}-*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::crpbot-market-data-${Environment}'
                  - !Sub 'arn:aws:s3:::crpbot-market-data-${Environment}/*'
                  - !Sub 'arn:aws:s3:::crpbot-logs-${Environment}'
                  - !Sub 'arn:aws:s3:::crpbot-logs-${Environment}/*'

  # Lambda Function
  SignalProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'crpbot-signal-processor-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      MemorySize: 512
      Timeout: 30
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          S3_MARKET_DATA_BUCKET: !Sub 'crpbot-market-data-${Environment}'
          S3_LOGS_BUCKET: !Sub 'crpbot-logs-${Environment}'
          DB_HOST: !Sub 'crpbot-${Environment}.cyjcoys82evx.us-east-1.rds.amazonaws.com'
          DB_NAME: postgres
          DB_USERNAME: crpbot_admin
          DB_PASSWORD: TempPassword123!
          COINBASE_SECRET_ARN: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:crpbot/coinbase-api/${Environment}-dHLD4h'
          ENVIRONMENT: !Ref Environment
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          import logging
          import psycopg
          from datetime import datetime
          
          logger = logging.getLogger()
          logger.setLevel(logging.INFO)
          
          def lambda_handler(event, context):
              logger.info("Signal processor started")
              
              try:
                  # Initialize clients
                  s3 = boto3.client('s3')
                  secrets = boto3.client('secretsmanager')
                  
                  # Test S3 connection
                  bucket = os.environ['S3_MARKET_DATA_BUCKET']
                  logs_bucket = os.environ['S3_LOGS_BUCKET']
                  
                  # Test Secrets Manager
                  secret_response = secrets.get_secret_value(
                      SecretId=os.environ['COINBASE_SECRET_ARN']
                  )
                  secret_data = json.loads(secret_response['SecretString'])
                  
                  # Test RDS connection
                  conn_string = f"host={os.environ['DB_HOST']} port=5432 dbname={os.environ['DB_NAME']} user={os.environ['DB_USERNAME']} password={os.environ['DB_PASSWORD']}"
                  
                  with psycopg.connect(conn_string) as conn:
                      with conn.cursor() as cur:
                          cur.execute("SELECT 'Lambda RDS connection successful' as status, current_timestamp;")
                          result = cur.fetchone()
                          logger.info(f"RDS test: {result}")
                  
                  # Log to S3
                  log_key = f"lambda-logs/{datetime.now().strftime('%Y/%m/%d')}/signal-processor-{context.aws_request_id}.log"
                  api_key_preview = secret_data.get('api_key', 'Not found')[:30] + '...'
                  log_content = f"Signal processor executed at {datetime.now()}\nRequest ID: {context.aws_request_id}\nCoinbase API Key: {api_key_preview}\nRDS Connection: Successful\nS3 Access: Successful\n"
                  
                  s3.put_object(
                      Bucket=logs_bucket,
                      Key=log_key,
                      Body=log_content,
                      ContentType='text/plain'
                  )
                  
                  logger.info("Signal processor completed successfully")
                  
                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': 'Signal processor executed successfully',
                          'timestamp': datetime.now().isoformat(),
                          'log_location': f"s3://{logs_bucket}/{log_key}",
                          'rds_connection': 'successful',
                          'secrets_access': 'successful',
                          's3_access': 'successful'
                      })
                  }
                  
              except Exception as e:
                  logger.error(f"Error in signal processor: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e),
                          'timestamp': datetime.now().isoformat()
                      })
                  }

  # EventBridge Rule for 5-minute schedule
  SignalProcessorSchedule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub 'crpbot-signal-schedule-${Environment}'
      Description: 'Trigger signal processor every 5 minutes'
      ScheduleExpression: 'rate(5 minutes)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt SignalProcessorFunction.Arn
          Id: 'SignalProcessorTarget'

  # Permission for EventBridge to invoke Lambda
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SignalProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SignalProcessorSchedule.Arn

Outputs:
  LambdaFunctionArn:
    Description: ARN of the signal processor Lambda function
    Value: !GetAtt SignalProcessorFunction.Arn

  EventBridgeRuleArn:
    Description: ARN of the EventBridge schedule rule
    Value: !GetAtt SignalProcessorSchedule.Arn

  IAMRoleArn:
    Description: ARN of the Lambda execution role
    Value: !GetAtt LambdaExecutionRole.Arn