# V4 Monitoring & Execution System

**Production monitoring and execution system for V3 ML models**

---

## Overview

V4 wraps around V3 trained models to provide:
- **Traffic light system** (ðŸŸ¢ðŸŸ¡ðŸ”´) for safe trading
- **Automated monitoring** of performance and system health
- **Smart alerts** via Telegram & Email
- **Dashboard** for quick daily check-ins
- **Signal formatting** with entry/SL/TP
- **Auto win/loss tracking** via Bybit API

**User workflow**: Check dashboard once/day (2 min), execute 3-5 signals (10 min). Total: 15 min/day.

---

## Architecture

```
V3 ML Models (ONNX)
        â†“
Signal Generator (filter + format) â†’ PostgreSQL
        â†“
Trading Controller (ðŸŸ¢ðŸŸ¡ðŸ”´ logic)
        â†“
Dashboard (Streamlit) + Alerts (Telegram/Email)
        â†“
User (15 min/day)
        â†“
Bybit API (execution + monitoring)
        â†“
Performance Monitor (auto track wins/losses)
```

---

## Components

### 1. Signal Generator (`components/signal_generator.py`)
- Loads V3 predictions every 15 minutes
- Filters: confidence â‰¥77%, volume â‰¥2x, RR â‰¥2.0
- Calculates entry/SL/TP/position size
- Stores to `signals` table
- Output: 8-12 best signals/day

### 2. Performance Monitor (`components/performance_monitor.py`)
- Watches Bybit positions via API
- Auto-records wins/losses when TP/SL hit
- Calculates rolling metrics (WR, Sharpe, ECE)
- Updates `trades` and `performance_snapshots` tables
- Runs: After each trade close + hourly snapshots

### 3. Trading Controller (`components/trading_controller.py`)
- Checks safety conditions
- Sets traffic light status (ðŸŸ¢ðŸŸ¡ðŸ”´)
- Adjusts position size multiplier
- Stores to `controller_status` table
- Triggers: After each trade, on signal generation, dashboard load

### 4. Alert System (`alerts/telegram_bot.py`, `alerts/email_sender.py`)
- Sends 6 types of alerts:
  1. Daily status (8 AM)
  2. Signal alerts (real-time)
  3. Warnings (yellow status)
  4. Critical (red status - Telegram + Email)
  5. Weekly reports (Monday 8 AM)
  6. Predictive warnings (WR declining, ECE drift, etc.)
- Rate limits: 12 signals/day, 3 warnings/hour

### 5. Dashboard (`dashboard/app.py`)
- Streamlit web app
- Shows: Traffic light, performance cards, signals, health checks
- Auto-refresh: 60 seconds
- Mobile responsive
- Password protected
- <2 second load time

### 6. Execution Helper (`components/execution_helper.py`) - Optional
- Mode A: Copy-paste formatter
- Mode B: Semi-automated via Bybit API (preview â†’ confirm â†’ execute)

---

## Database Schema

### PostgreSQL Tables

```sql
-- Signals generated by ML
CREATE TABLE signals (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    coin VARCHAR(20) NOT NULL,
    direction VARCHAR(4) NOT NULL, -- 'LONG' or 'SHORT'
    confidence FLOAT NOT NULL,
    entry_low FLOAT NOT NULL,
    entry_high FLOAT NOT NULL,
    stop_loss FLOAT NOT NULL,
    take_profit FLOAT NOT NULL,
    position_size FLOAT NOT NULL,
    signal_type VARCHAR(20), -- 'mean_reversion', 'sentiment_divergence', etc.
    reasoning TEXT,
    status VARCHAR(20) DEFAULT 'ready', -- 'ready', 'paused', 'expired', 'executed'
    tier INT, -- 1, 2, or 3
    created_at TIMESTAMP DEFAULT NOW()
);

-- Trades executed and tracked
CREATE TABLE trades (
    id SERIAL PRIMARY KEY,
    signal_id INT REFERENCES signals(id),
    coin VARCHAR(20) NOT NULL,
    direction VARCHAR(4) NOT NULL,
    entry_price FLOAT NOT NULL,
    exit_price FLOAT,
    entry_time TIMESTAMP NOT NULL,
    exit_time TIMESTAMP,
    win BOOLEAN,
    pnl FLOAT,
    pnl_percent FLOAT,
    exit_reason VARCHAR(50), -- 'TP', 'SL', 'manual', 'timeout'
    created_at TIMESTAMP DEFAULT NOW()
);

-- Performance snapshots
CREATE TABLE performance_snapshots (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    win_rate_last_20 FLOAT,
    pnl_daily FLOAT,
    pnl_weekly FLOAT,
    pnl_monthly FLOAT,
    sharpe_ratio FLOAT,
    max_drawdown FLOAT,
    ece FLOAT, -- Expected Calibration Error
    consecutive_losses INT,
    total_trades INT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Controller status (traffic light)
CREATE TABLE controller_status (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    status VARCHAR(10) NOT NULL, -- 'green', 'yellow', 'red'
    message TEXT NOT NULL,
    position_multiplier FLOAT NOT NULL, -- 1.0, 0.5, or 0.0
    triggered_by VARCHAR(100), -- What caused the status
    created_at TIMESTAMP DEFAULT NOW()
);

-- Alerts sent
CREATE TABLE alerts_sent (
    id SERIAL PRIMARY KEY,
    alert_type VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    sent_at TIMESTAMP NOT NULL,
    delivered BOOLEAN DEFAULT FALSE,
    channel VARCHAR(20), -- 'telegram', 'email'
    created_at TIMESTAMP DEFAULT NOW()
);

-- Per-signal-type performance
CREATE TABLE signal_type_performance (
    id SERIAL PRIMARY KEY,
    signal_type VARCHAR(20) NOT NULL,
    period VARCHAR(20) NOT NULL, -- 'last_20', 'week', 'month'
    win_rate FLOAT,
    trade_count INT,
    avg_pnl FLOAT,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Per-coin performance
CREATE TABLE coin_performance (
    id SERIAL PRIMARY KEY,
    coin VARCHAR(20) NOT NULL,
    period VARCHAR(20) NOT NULL,
    win_rate FLOAT,
    trade_count INT,
    avg_pnl FLOAT,
    tier INT,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## Installation

### Requirements
- Python 3.9+
- PostgreSQL 13+
- Redis (optional, for caching)
- Nginx (for production)
- SSL certificate

### Setup

```bash
# 1. Clone repo
cd /home/numan/crpbot/v4_monitoring

# 2. Install dependencies
pip install -r requirements.txt

# 3. Setup database
psql -U crpbot_admin -d crpbot -f database/schema.sql

# 4. Configure environment
cp config/config.example.yaml config/config.yaml
# Edit config.yaml with your settings

# 5. Setup Telegram bot
# Follow: https://core.telegram.org/bots#creating-a-new-bot
# Add token to config.yaml

# 6. Test components
python tests/test_signal_generator.py
python tests/test_controller.py

# 7. Run services
# Signal generator (cron every 15 min)
*/15 * * * * python components/signal_generator.py

# Dashboard (always on)
streamlit run dashboard/app.py --server.port 8501

# Alerts (event-driven, runs as daemon)
python alerts/alert_daemon.py &
```

---

## Configuration

Edit `config/config.yaml`:

```yaml
# V3 ML Models
models:
  path: /path/to/v3/models/onnx/
  ensemble_models: [xgboost, lightgbm, catboost, tabnet, automl]
  meta_learner: meta_learner.onnx

# Bybit API
bybit:
  api_key: YOUR_API_KEY
  api_secret: YOUR_API_SECRET
  testnet: false  # Set true for testing

# Telegram
telegram:
  bot_token: YOUR_BOT_TOKEN
  chat_id: YOUR_CHAT_ID

# Email (optional)
email:
  smtp_server: smtp.gmail.com
  smtp_port: 587
  from_email: your@email.com
  password: YOUR_APP_PASSWORD
  to_email: alerts@yourdomain.com

# Database
database:
  host: crpbot-rds-postgres-db.cyjcoys82evx.us-east-1.rds.amazonaws.com
  port: 5432
  database: crpbot
  user: crpbot_admin
  password: FROM_SECRETS_MANAGER

# Trading parameters
trading:
  max_signals_per_day: 12
  min_confidence: 0.77
  min_volume_ratio: 2.0
  min_risk_reward: 2.0
  base_risk_per_trade: 0.015  # 1.5%

# Controller thresholds
controller:
  red_wr_threshold: 0.65
  yellow_wr_threshold: 0.70
  red_daily_loss: 0.04  # 4%
  red_consecutive_losses: 5
  red_ece_threshold: 0.08

# Dashboard
dashboard:
  port: 8501
  password: YOUR_DASHBOARD_PASSWORD
  refresh_interval: 60  # seconds
```

---

## Usage

### Daily Workflow (15 min)

**Morning (2 min)**:
1. Check Telegram for daily status message (arrives 8 AM)
2. See traffic light: ðŸŸ¢ = trade today, ðŸ”´ = skip

**Throughout day (10 min)**:
1. Telegram alerts you of new signals (3-5/day)
2. Open dashboard: `https://yourdomain.com:8501`
3. Click signal â†’ copy entry/SL/TP
4. Paste to Bybit â†’ execute
5. System auto-tracks when closed

**Monday (3 min)**:
1. Email: Weekly report
2. Review performance
3. If issues â†’ investigate

---

## Traffic Light Logic

### ðŸŸ¢ GREEN (Trade Normally)
- WR last 20 â‰¥70%
- Daily loss <4%
- Consecutive losses <5
- ECE <8%
- All APIs working
- Volatility normal

**Action**: position_multiplier = 1.0

---

### ðŸŸ¡ YELLOW (Reduce Risk)
- WR last 20: 65-70%
- Daily loss: 3-4%
- Consecutive losses: 4
- ECE: 6-8%
- 1 signal type failing

**Action**: position_multiplier = 0.5 (half size)

---

### ðŸ”´ RED (Stop Trading)
- WR last 20 <65%
- Daily loss >4%
- Consecutive losses â‰¥5
- ECE >8%
- System error (API down)
- Volatility >5Ã— normal
- 2+ signal types failing

**Action**: position_multiplier = 0.0 (no trades)

**Alerts**: Telegram + Email "CRITICAL: DO NOT TRADE"

---

## Monitoring & Alerts

### 6 Alert Types

1. **Daily Status** (8 AM)
   - Traffic light status
   - Yesterday's P&L
   - Win rate last 20
   - Signals ready for today

2. **Signal Alerts** (Real-time)
   - New signal details
   - Entry/SL/TP/size
   - Confidence + reasoning
   - Execute or paused?

3. **Warnings** (Yellow status)
   - What triggered yellow
   - Current metrics
   - Recommended action

4. **Critical** (Red status)
   - Telegram + Email
   - "DO NOT TRADE"
   - What went wrong
   - How to fix

5. **Weekly Report** (Monday 8 AM)
   - Week's P&L
   - Win rate trend
   - Best/worst signals
   - System health

6. **Predictive Warnings**
   - WR declining (2%+ drop/week Ã— 2 weeks)
   - Confidence drift (ECE rising)
   - Signal type degradation
   - Market regime change

---

## Testing

Run test suite:

```bash
# Unit tests
pytest tests/

# Integration tests
pytest tests/integration/

# End-to-end test
python tests/test_e2e.py
```

**Acceptance checklist** (`tests/acceptance_checklist.md`):
- [ ] Dashboard shows ðŸŸ¢ðŸŸ¡ðŸ”´ correctly
- [ ] Signals display with entry/SL/TP
- [ ] Telegram daily status (8 AM)
- [ ] Telegram signal alerts (real-time)
- [ ] Telegram warnings (yellow)
- [ ] Telegram + email critical (red)
- [ ] Weekly report (Monday 8 AM)
- [ ] Performance metrics accurate
- [ ] Auto win/loss detection works
- [ ] Dashboard loads <2s
- [ ] Mobile responsive
- [ ] System survives API failure
- [ ] All 6 predictive warnings trigger

---

## Deployment

### VPS Specs (Minimum)
- 2GB RAM
- 2 CPU cores
- 20GB SSD
- Ubuntu 22.04 LTS

### Services
1. **PostgreSQL**: Database
2. **Streamlit**: Dashboard (port 8501)
3. **Cron**: Signal generator (every 15 min)
4. **Systemd**: Alert daemon
5. **Nginx**: Reverse proxy + SSL
6. **UptimeRobot**: Health monitoring

### SSL Setup
```bash
# Install certbot
sudo apt install certbot python3-certbot-nginx

# Get certificate
sudo certbot --nginx -d yourdomain.com

# Auto-renew
sudo certbot renew --dry-run
```

---

## Cost

### Monthly Recurring
- VPS (2GB RAM): $10-20/mo (DigitalOcean, Linode)
- Domain + SSL: $1-2/mo (Cloudflare)
- **Total**: $11-22/mo

### One-Time
- Setup time: 2-3 hours

---

## Troubleshooting

### Dashboard won't load
- Check: `systemctl status streamlit`
- Check: `curl localhost:8501`
- Fix: `systemctl restart streamlit`

### Telegram alerts not sending
- Check: `tail -f logs/alerts.log`
- Test: `python alerts/test_telegram.py`
- Verify: Bot token in config.yaml

### No signals generated
- Check: `ls /path/to/v3/models/onnx/`
- Check: `python components/test_ml_inference.py`
- Check: Bybit API connectivity

### Auto tracking not working
- Check: Bybit API keys
- Check: `python components/test_bybit_monitor.py`
- Verify: Positions exist in Bybit

---

## Support & Maintenance

### Weekly tasks
- Review performance metrics
- Check error logs
- Verify backups

### Monthly tasks
- Retrain V3 models (if needed)
- Update tier assignments
- Review alert effectiveness

---

## Timeline (18-20 days)

| Days | Component | Status |
|------|-----------|--------|
| 1-2 | Signal Generator | ðŸ”„ In progress |
| 3-5 | Performance Monitor | â³ Pending |
| 6-7 | Trading Controller | â³ Pending |
| 8-9 | Alert System | â³ Pending |
| 10-14 | Dashboard | â³ Pending |
| 15-17 | Execution Helper | â³ Pending |
| 18 | Integration Testing | â³ Pending |
| 19 | Deployment | â³ Pending |
| 20 | User Acceptance | â³ Pending |

---

**Ready to build!** Starting with Component 1: Signal Generator...
