# Prometheus Alert Rules for HYDRA 4.0
# These rules trigger alerts based on HYDRA metrics

groups:
  - name: hydra_critical
    interval: 15s
    rules:
      # HYDRA Runtime Down
      - alert: HydraRuntimeDown
        expr: up{job="hydra"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HYDRA Runtime is DOWN"
          description: "HYDRA runtime has been unreachable for more than 2 minutes. Check the process and logs."

      # Daily Drawdown Exceeded
      - alert: DailyDrawdownExceeded
        expr: hydra_daily_drawdown_percent > 4.5
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Daily drawdown limit exceeded"
          description: "Daily drawdown is {{ $value }}%, exceeding the 4.5% FTMO limit. Trading should be paused."

      # Total Drawdown Exceeded
      - alert: TotalDrawdownExceeded
        expr: hydra_total_drawdown_percent > 9
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Total drawdown limit exceeded"
          description: "Total drawdown is {{ $value }}%, exceeding the 9% FTMO limit. IMMEDIATE ACTION REQUIRED."

      # Kill Switch Activated
      - alert: KillSwitchActivated
        expr: hydra_kill_switch_active == 1
        for: 10s
        labels:
          severity: critical
        annotations:
          summary: "HYDRA Kill Switch ACTIVATED"
          description: "The HYDRA kill switch has been activated. All trading is halted. Manual intervention required."

  - name: hydra_warning
    interval: 30s
    rules:
      # Consecutive Losses
      - alert: ConsecutiveLosses
        expr: hydra_consecutive_losses >= 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "{{ $value }} consecutive losing trades"
          description: "HYDRA has had {{ $value }} consecutive losing trades. Consider reviewing strategy performance."

      # Engine Offline
      - alert: EngineOffline
        expr: hydra_engine_active{engine=~"A|B|C|D"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Engine {{ $labels.engine }} is offline"
          description: "Gladiator Engine {{ $labels.engine }} has been offline for 5+ minutes. Check API connectivity."

      # High API Latency
      - alert: HighAPILatency
        expr: hydra_api_latency_seconds > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High API latency detected"
          description: "API latency is {{ $value }}s, which may affect trade execution timing."

      # Low Win Rate
      - alert: LowWinRate
        expr: hydra_win_rate_24h < 40
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Low 24h win rate: {{ $value }}%"
          description: "The 24-hour win rate has dropped to {{ $value }}%. Consider reviewing strategy parameters."

  - name: hydra_bug_detection
    interval: 30s
    rules:
      # Engine Error Rate High
      - alert: EngineErrorRateHigh
        expr: increase(hydra_engine_errors_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Engine {{ $labels.engine }} error rate high"
          description: "Engine {{ $labels.engine }} has had {{ $value }} errors in the last 5 minutes. Check API connectivity and logs."

      # No Trades Generated
      - alert: NoTradesGenerated
        expr: increase(hydra_trades_total[1h]) == 0 and hydra_iterations_total > 12
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "No trades generated in 1 hour"
          description: "HYDRA has been running but generated no trades in the past hour. Check engine triggers and thresholds."

      # Engine Low Confidence Spam
      - alert: EngineLowConfidenceSpam
        expr: increase(hydra_engine_low_confidence_total[15m]) > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Engine {{ $labels.engine }} producing low confidence strategies"
          description: "Engine {{ $labels.engine }} has produced {{ $value }} low confidence (<55%) strategies in 15 min. Check prompts/data feeds."

      # Portfolio Blown
      - alert: PortfolioBlown
        expr: hydra_engine_portfolio_balance < 100
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Engine {{ $labels.engine }} portfolio blown"
          description: "Engine {{ $labels.engine }} portfolio balance is ${{ $value }}, below $100 minimum. Engine should be disabled."

      # Data Feed Errors
      - alert: DataFeedErrors
        expr: increase(hydra_data_feed_errors_total[10m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Data feed errors detected"
          description: "{{ $value }} data feed errors in the last 10 minutes. Check Coinbase/exchange API connectivity."

      # Checkpoint Failed
      - alert: CheckpointFailed
        expr: time() - hydra_last_checkpoint_timestamp > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "State checkpoint stale"
          description: "No checkpoint saved in {{ $value }}s. Check disk space and write permissions."

      # Duplicate Order Blocked
      - alert: DuplicateOrdersBlocked
        expr: increase(hydra_duplicate_orders_blocked_total[1h]) > 10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Frequent duplicate orders blocked"
          description: "{{ $value }} duplicate orders blocked in 1 hour. Check for runaway engine or logic bugs."

  - name: hydra_info
    interval: 1m
    rules:
      # New Trade Opened
      - alert: TradeOpened
        expr: increase(hydra_trades_total[5m]) > 0
        for: 0s
        labels:
          severity: info
        annotations:
          summary: "New trade opened"
          description: "A new trade has been opened by HYDRA."

      # Engine Weight Changed
      - alert: EngineWeightChanged
        expr: changes(hydra_engine_weight[1h]) > 0
        for: 0s
        labels:
          severity: info
        annotations:
          summary: "Engine tournament weights updated"
          description: "The tournament manager has updated engine weights based on performance."

      # Trade Closed
      - alert: TradeClosed
        expr: increase(hydra_trades_closed_total[5m]) > 0
        for: 0s
        labels:
          severity: info
        annotations:
          summary: "Trade closed: {{ $labels.outcome }}"
          description: "A trade has been closed with outcome: {{ $labels.outcome }}."
